---
- name: Hard Restart VM (Safe Method)
  hosts: localhost
  gather_facts: false
  tasks:

    - name: Ensure VM RunStrategy is set to Always
      kubernetes.core.k8s:
        state: patched
        kind: VirtualMachine
        api_version: kubevirt.io/v1
        name: "{{ vmname }}"
        namespace: "{{ target_namespace }}"
        definition:
          spec:
            runStrategy: Always
            running: null

    - name: Delete VMI to trigger a restart
      kubernetes.core.k8s:
        state: absent
        api_version: kubevirt.io/v1
        kind: VirtualMachineInstance
        name: "{{ vmname }}"
        namespace: "{{ target_namespace }}"
      ignore_errors: true

    - name: Wait for VMI to be Running and Ready
      kubernetes.core.k8s_info:
        api_version: kubevirt.io/v1
        kind: VirtualMachineInstance
        name: "{{ vmname }}"
        namespace: "{{ target_namespace }}"
      register: vmi_status
      until:
        - vmi_status.resources | length > 0
        - vmi_status.resources[0].status.phase == 'Running'
      retries: 30
      delay: 10
